name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubicloud-standard-4-ubuntu-2404
    timeout-minutes: 10
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build and test
      run: |
        # Use the CI Dockerfile with dev-hoard
        docker build -f Dockerfile.ci -t ht2-test:ci .
        
        # Check formatting
        docker run --rm -v $PWD:/app ht2-test:ci \
          crystal tool format --check
        
        # Run tests
        docker run --rm \
          -e CRYSTAL_WORKERS=$(nproc) \
          -e TEST_CERT_PATH=/certs \
          -e LOG_LEVEL=ERROR \
          -v $PWD:/app \
          ht2-test:ci \
          sh -c "find spec -name '*_spec.cr' \
            -not -path '*/integration/curl*' \
            -not -name 'cve_integration_spec.cr' \
            -not -name 'stream_lifecycle_integration_spec.cr.disabled' | \
            xargs crystal spec --no-color"
        
        # Build release
        docker run --rm -v $PWD:/app ht2-test:ci \
          crystal build --release src/ht2.cr
        
        # Verify binary was created
        ls -lah ht2

  test-specific:
    runs-on: ubicloud-standard-4-ubuntu-2404
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        test-suite:
          - { name: "H2C", specs: "spec/h2c_prior_knowledge_spec.cr spec/ht2/h2c_integration_spec.cr spec/ht2/h2c_spec.cr spec/h2c_detection_spec.cr" }
          - { name: "Core", specs: "spec/frames_spec.cr spec/hpack_spec.cr spec/stream_spec.cr spec/buffered_socket_spec.cr" }
          - { name: "Server", specs: "spec/server_spec.cr spec/ht2/worker_pool_spec.cr" }
    
    name: Test ${{ matrix.test-suite.name }}
    steps:
    - uses: actions/checkout@v4
    
    - name: Build test image
      run: docker build -f Dockerfile.ci -t ht2-test:ci .
    
    - name: Run ${{ matrix.test-suite.name }} tests
      run: |
        docker run --rm \
          -e CRYSTAL_WORKERS=$(nproc) \
          -e TEST_CERT_PATH=/certs \
          -v $PWD:/app \
          ht2-test:ci \
          crystal spec --no-color ${{ matrix.test-suite.specs }}

  lint:
    runs-on: ubicloud-standard-4-ubuntu-2404
    timeout-minutes: 5
    continue-on-error: true
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Build test image
      run: docker build -f Dockerfile.ci -t ht2-test:ci .
    
    - name: Lint with ameba
      run: |
        docker run --rm -v $PWD:/app ht2-test:ci \
          sh -c "cd /app && crystal run lib/ameba/src/cli.cr -- src spec --except Metrics/CyclomaticComplexity || true"

  check-status:
    runs-on: ubuntu-latest
    needs: [test, test-specific, lint]
    if: always()
    steps:
    - name: Check job statuses
      run: |
        if [ "${{ needs.test.result }}" != "success" ] || \
           [ "${{ needs.test-specific.result }}" != "success" ] || \
           [ "${{ needs.lint.result }}" != "success" ]; then
          echo "One or more jobs failed:"
          echo "test: ${{ needs.test.result }}"
          echo "test-specific: ${{ needs.test-specific.result }}"
          echo "lint: ${{ needs.lint.result }}"
          exit 1
        else
          echo "All jobs completed successfully"
        fi